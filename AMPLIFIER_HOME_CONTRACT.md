# Amplifier Directory Contract

> Canonical specification for the `~/.amplifier/` filesystem layout.
> All interfaces, tools, and modules MUST conform to this contract.

## Overview

Amplifier stores all persistent state under a single root directory,
defaulting to `~/.amplifier/`. This can be overridden via the
`AMPLIFIER_HOME` environment variable.

## Directory Layout

```
~/.amplifier/                        # AMPLIFIER_HOME
  settings.yaml                      # User configuration (global)
  cache/                             # Module and bundle cache
    <name>-<hash>/                   # Cached git clone (shallow)
    install-state.json               # Module installation tracking
  projects/                          # Per-project state
    <project-slug>/                  # Derived from working directory name
      sessions/                      # Session storage
        <session-id>/                # One directory per session
          transcript.jsonl           # Conversation transcript
          events.jsonl               # System events log
          metadata.json              # Session metadata
          handoff.md                 # Session handoff summary (auto-generated)
      recipe-sessions/               # Recipe execution state
  memory/                            # Shared memory store
    memory-store.yaml                # Facts, preferences, learnings
    work-log.yaml                    # Active work, pending decisions
  modes/                             # User-defined modes
    <mode-name>.md                   # Mode definition files
  skills/                            # User-defined skills
    <skill-name>/                    # Skill packages
  bundles/                           # Registered bundle references
  AGENTS.md                          # User-global agent instructions
```

## Path Derivation

### Project Slug

The project slug is derived from the working directory name:
- `/home/user/dev/my-project/` → `my-project`
- `/home/user/dev/amplifier-core/` → `amplifier-core`

This enables automatic session-to-project mapping without manual tagging.

### Session ID

Session IDs are generated by the kernel and are globally unique. Format
is implementation-defined but must be filesystem-safe.

### Cache Entry Names

Cache entries use `<name>-<hash>` format where:
- `name` is derived from the git repository name
- `hash` is a content-addressable hash for deduplication

## Ownership and Lifecycle

| Directory | Owner | Created By | Cleaned By |
|-----------|-------|------------|------------|
| `settings.yaml` | User / `amplifier init` | `amplifier init` or manual | User |
| `cache/` | Cache subsystem | Module/bundle loader | `amplifier reset --remove cache` |
| `projects/` | Session subsystem | Session creation | User or `amplifier reset` |
| `memory/` | Memory subsystem | First memory write | User |
| `modes/` | User | Manual | User |
| `skills/` | User / skill loader | Manual or skill install | User |
| `bundles/` | Bundle subsystem | `amplifier bundle add` | `amplifier bundle remove` |
| `AGENTS.md` | User / AI | Manual or AI-generated | User |

## Concurrency

- Session directories are owned by a single session process. No locking needed.
- `settings.yaml` is read at startup. Concurrent writes are not supported.
- `cache/` entries use atomic replacement (write to temp, rename) to avoid partial states.
- `memory/` files may be read by multiple sessions. Write serialization is the caller's responsibility.
- `handoff.md` is written at session end inside that session's directory. No concurrent access expected.

## Security

- `settings.yaml` should be readable only by the owner (chmod 600 recommended).
- API keys should be stored in environment variables, NOT in `settings.yaml`.
- Session transcripts may contain sensitive information. The `projects/` directory should have restricted permissions.
- The `cache/` directory contains cloned git repos. Access permissions follow the parent directory.

## Environment Variables

| Variable | Purpose | Default |
|----------|---------|---------|
| `AMPLIFIER_HOME` | Override the root directory | `~/.amplifier` |
| `AMPLIFIER_CACHE_DIR` | Override cache location | `$AMPLIFIER_HOME/cache` |
| `AMPLIFIER_PROJECTS_DIR` | Override projects location | `$AMPLIFIER_HOME/projects` |

## Compatibility

This contract is versioned with amplifier-foundation. Changes to the directory
layout MUST be backward-compatible or accompanied by a migration path.

Interfaces that conform to this contract can interoperate seamlessly —
sessions started in the CLI can be resumed in the TUI, handoffs written
by hooks can be read by any interface.